<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Joining time-series data · QuestDB</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Modern time-series applications store metrics upon change rather than at regular intervals."/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Joining time-series data · QuestDB"/><meta property="og:type" content="website"/><meta property="og:url" content="https://questdb.io/blog/2020/03/22/asof"/><meta property="og:description" content="Modern time-series applications store metrics upon change rather than at regular intervals."/><meta property="og:image" content="https://questdb.io/img/favicon.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://questdb.io/img/favicon.png"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://questdb.io/blog/atom.xml" title="QuestDB Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://questdb.io/blog/feed.xml" title="QuestDB Blog RSS Feed"/><script>
              (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
              (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

              ga('create', 'UA-145747842-1', 'auto');
              ga('send', 'pageview');
            </script><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,500,600,700|Source+Code+Pro:400,700|Open+Sans:300,400,600,700"/><link rel="stylesheet" href="/css/code-block-buttons.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.0/clipboard.min.js"></script><script type="text/javascript" src="/js/code-block-buttons.js"></script><script type="text/javascript" src="/js/console-demo.js"></script><script type="text/javascript" src="/js/getstarted.js"></script><script type="text/javascript" src="/js/signup.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/QuestDB_Logo.png" alt="QuestDB"/><h2 class="headerTitleWithLogo">QuestDB</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/" target="_self">Home</a></li><li class=""><a href="/getstarted" target="_self">Get QuestDB</a></li><li class=""><a href="/docs/documentationOverview" target="_self">Documentation</a></li><li class="siteNavGroupActive"><a href="/blog/" target="_self">Blog</a></li><li class=""><a href="/careers" target="_self">Careers</a></li><li class=""><a href="/about" target="_self">About</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search..." title="Search..."/></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Recent Posts</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">Recent Posts</h3><ul class=""><li class="navListItem navListItemActive"><a class="navItem" href="/blog/2020/03/22/asof">Joining time-series data</a></li><li class="navListItem"><a class="navItem" href="/blog/2019/12/19/lineprot">Speeding up Influx Line Protocol</a></li><li class="navListItem"><a class="navItem" href="/blog/2019/10/05/interthread">The art of thread messaging</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer postContainer blogContainer"><div class="wrapper"><div class="lonePost"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle"><a href="/blog/2020/03/22/asof">Joining time-series data</a></h1><p class="post-meta">March 22, 2020</p><div class="authorBlock"><p class="post-authorName"><a target="_blank" rel="noreferrer noopener">Tancrede Collard</a></p></div></header><div><span><p>Modern time-series applications store metrics upon change rather than at regular intervals.
This removes the need to hold static values when the series don't change, but keeps the possibility
to catch bursts when required with a  high degree of precision.</p>
<p>The consequence is a de-normalization of timestamps for time-series.
Data is stored at varying time intervals, with different timestamps.
It makes analysis across different series challenging because it is very unlikely
that the timestamps will exactly match.</p>
<p>With relational databases, joining time-series based on timestamp
is either impossible, or at best inefficient. This is not because relational databases are bad,
but rather because they were not designed for time-series.</p>
<h3><a class="anchor" aria-hidden="true" id="why-time-series-joins"></a><a href="#why-time-series-joins" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Why time-series joins?</h3>
<p>In a nutshell, to join tables on timestamp, even when they don't exactly match.</p>
<p>Let's assume these two tables:</p>
<p>Taxi rides:</p>
<pre><code class="hljs">| timestamp                   | trip_dist | 
|-----------------------------|-----------|
| <span class="hljs-number">2019</span><span class="hljs-number">-10</span><span class="hljs-number">-17</span>T00:<span class="hljs-number">00</span>:<span class="hljs-number">00.000000</span>Z | <span class="hljs-number">2.5</span>       | 
| <span class="hljs-number">2019</span><span class="hljs-number">-10</span><span class="hljs-number">-17</span>T00:<span class="hljs-number">00</span>:<span class="hljs-number">00.000000</span>Z | <span class="hljs-number">1.2</span>       | 
| <span class="hljs-number">2019</span><span class="hljs-number">-10</span><span class="hljs-number">-17</span>T00:<span class="hljs-number">00</span>:<span class="hljs-number">00.000000</span>Z | <span class="hljs-number">2.8</span>       |
| <span class="hljs-number">2019</span><span class="hljs-number">-10</span><span class="hljs-number">-17</span>T00:<span class="hljs-number">00</span>:<span class="hljs-number">00.000000</span>Z | <span class="hljs-number">7.5</span>       |
</code></pre>
<p>Weather observations:</p>
<pre><code class="hljs">| timestamp                   | temperature |
|-----------------------------|-------------|
| <span class="hljs-number">2019</span><span class="hljs-number">-10</span><span class="hljs-number">-17</span>T00:<span class="hljs-number">00</span>:<span class="hljs-number">00.000000</span>Z | <span class="hljs-number">22</span>          | 
| <span class="hljs-number">2019</span><span class="hljs-number">-10</span><span class="hljs-number">-17</span>T00:<span class="hljs-number">00</span>:<span class="hljs-number">00.000000</span>Z | <span class="hljs-number">15</span>          | 
| <span class="hljs-number">2019</span><span class="hljs-number">-10</span><span class="hljs-number">-17</span>T00:<span class="hljs-number">00</span>:<span class="hljs-number">00.000000</span>Z | <span class="hljs-number">8</span>           | 
| <span class="hljs-number">2019</span><span class="hljs-number">-10</span><span class="hljs-number">-17</span>T00:<span class="hljs-number">00</span>:<span class="hljs-number">00.000000</span>Z | <span class="hljs-number">7.5</span>         |
</code></pre>
<p>One might want to use this data to analyse how the weather affects the taxi business.
For example, are customers more likely to hail a cab when it's cold outside.
To do this, you need a way to match weather to a given taxi ride.</p>
<p>Both tables have a timestamp column. However, The timestamps do not match. Let's look at
ways to solve this problem.</p>
<h3><a class="anchor" aria-hidden="true" id="using-a-relational-database"></a><a href="#using-a-relational-database" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using a relational database</h3>
<p>Relational databases highly inefficient at joining time-series data. They would usually answer this sort
of query using either of two ways:</p>
<h4><a class="anchor" aria-hidden="true" id="with-outer-join"></a><a href="#with-outer-join" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>With OUTER JOIN</h4>
<p>OUTER JOIN returns all records from the LEFT table, and the matching records in the RIGHT
table. All records in the right table must match, otherwise results will look like this:</p>
<pre><code class="hljs">| timestamp                   | trip_dist | temperature   | 
|-----------------------------|-----------|---------------|
| <span class="hljs-number">2019</span><span class="hljs-number">-10</span><span class="hljs-number">-17</span>T00:<span class="hljs-number">00</span>:<span class="hljs-number">00.000000</span>Z | <span class="hljs-number">2.5</span>       |               | 
| <span class="hljs-number">2019</span><span class="hljs-number">-10</span><span class="hljs-number">-17</span>T00:<span class="hljs-number">00</span>:<span class="hljs-number">00.000000</span>Z | <span class="hljs-number">1.2</span>       |               | 
| <span class="hljs-number">2019</span><span class="hljs-number">-10</span><span class="hljs-number">-17</span>T00:<span class="hljs-number">00</span>:<span class="hljs-number">00.000000</span>Z | <span class="hljs-number">2.8</span>       | <span class="hljs-number">15</span>:<span class="hljs-number">25</span>         | 
| <span class="hljs-number">2019</span><span class="hljs-number">-10</span><span class="hljs-number">-17</span>T00:<span class="hljs-number">00</span>:<span class="hljs-number">00.000000</span>Z | <span class="hljs-number">7.5</span>       |               | 
</code></pre>
<p>Most rides are missing temperature because the timestamps don't match. For this to work,
users must enforce that the WEATHER table gets updated with every taxi ride using the
exact same timestamp.</p>
<p>It works. But it is an extremely bad method for four reasons:</p>
<ul>
<li>if the timestamps are exactly the same in both tables, it may be more sensible to store them both as one table.</li>
<li>this method significantly slows down inserts.
For each new ride, the DB needs to lookup the latest weather observation and write it again with
the ride timestamp.</li>
<li>it takes way more space. The resulting schema
repeats weather observations for each new ride.</li>
<li>it slows down queries. Redundant data bloats tables without adding new information, making scans
longer.</li>
</ul>
<h4><a class="anchor" aria-hidden="true" id="with-nested-cross-join--order-by-subqueries"></a><a href="#with-nested-cross-join--order-by-subqueries" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>With nested CROSS JOIN / ORDER BY subqueries</h4>
<p>An alternative to OUTER JOIN yields the same result without requiring duplicated physical data on disk.
The algorithm is as follows:</p>
<p>For each row in the <code>trips</code> table:</p>
<ul>
<li>Select all observations from <code>weather</code> such that <code>weather.timestamp &lt;= trip.timestamp</code> (result size = n rows)</li>
<li>Order these observations by ascending timestamp.</li>
<li><code>CROSS JOIN</code> the ordered weather observations with the trip.</li>
<li>Add the <code>n</code> results to a table held in memory</li>
<li>Repeat for the next <code>trip</code></li>
</ul>
<p>An example of such query is as follows:</p>
<pre><code class="hljs css language-sql"><span class="hljs-keyword">select</span> *
<span class="hljs-keyword">from</span> (
 <span class="hljs-keyword">select</span> *
 <span class="hljs-keyword">from</span> trips) t
 <span class="hljs-keyword">cross</span> <span class="hljs-keyword">join</span> <span class="hljs-keyword">lateral</span> (
   <span class="hljs-keyword">select</span> *
   <span class="hljs-keyword">from</span> weather
   <span class="hljs-keyword">where</span> t.ts &gt; ts
 <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> ts <span class="hljs-keyword">DESC</span>
 <span class="hljs-keyword">limit</span> <span class="hljs-number">1</span>);
</code></pre>
<p>Again, this method works but is inefficient because</p>
<ul>
<li>It is very slow: for each trip, it needs to scan the weather table and bring rows with an
inferior timestamp. It then needs to run a sorting algorithm.</li>
<li>It requires a LOT of RAM. Assuming a trips table of size <code>n</code>, a weather table of size <code>m</code>, and
that <code>k</code> weather observations took place before the median trip, the table generated by the
CROSS join will be of size <code>n x k</code>. The first trip CROSS JOIN with weather will be 1 row.
The last trip CROSS JOIN with weather will be <code>n x m</code> rows</li>
</ul>
<h4><a class="anchor" aria-hidden="true" id="using-asof-join"></a><a href="#using-asof-join" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using ASOF JOIN</h4>
<p>Getting the same results with QuestDB is simple thanks to the <code>ASOF JOIN</code> function. The
above query can be answered simply by running the following sql:</p>
<pre><code class="hljs css language-sql">trips asof <span class="hljs-keyword">join</span> weather;
</code></pre>
<p>It is also extremely fast. First because of its design: it leverages the fact that timestamp sequences
are ordered, thus not requiring large table scans or ordering data. Second by construction: QuestDB implements it in such way that the path to data is</p>
</span></div></div><div class="blogSocialSection"></div></div><div class="blog-recent"><a class="button" href="/blog/">Recent Posts</a></div></div></div><nav class="onPageNav"></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><div align="left" class="footersection"><h5>QuestDB</h5><a href="/docs/documentationOverview">Documentation</a><a href="/getstarted">Download</a><a href="/docs/roadmap">Roadmap</a></div><div align="left" class="footersection"><h5>Community</h5><a href="https://stackoverflow.com/questions/tagged/" target="_blank" rel="noreferrer noopener">Stack Overflow</a><a href="https://join.slack.com/t/questdb/shared_invite/enQtNzk4Nzg4Mjc2MTE2LTEzZThjMzliMjUzMTBmYzVjYWNmM2UyNWJmNDdkMDYyZmE0ZDliZTQxN2EzNzk5MDE3Zjc1ZmJiZmFiZTIwMGY&gt;"> Join Slack </a><a href="https://twitter.com/" target="@QuestDB" rel="noreferrer noopener">Twitter</a></div><div align="left" class="footersection"><h5>More</h5><a href="/blog">Blog</a><a href="https://github.com/questdb/questdb/">GitHub</a><a class="github-button" href="https://github.com/questdb/questdb" data-icon="octicon-star" data-count-href="/questdb/questdb/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div></section><section class="copyright">Copyright © 2020 QuestDB</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: 'b2a69b4869a2a85284a82fb57519dcda',
                indexName: 'questdb',
                inputSelector: '#search_input_react',
                algoliaOptions: {}
              });
            </script></body></html>